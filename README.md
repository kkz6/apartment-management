# Apartment Management System

A full-stack apartment management application built for Indian residential complexes. Handles unit management, quarterly billing, payment reconciliation (GPay + HDFC bank statements), and real-time Google Sheets sync.

## Tech Stack

- **Backend:** Laravel 12, PHP 8.2+
- **Frontend:** Vue 3 + TypeScript, Inertia.js, Tailwind CSS 4, shadcn/ui (reka-ui)
- **AI/OCR:** Laravel AI SDK with Anthropic Claude (GPay screenshot OCR, PDF parsing)
- **Sheets:** Google Sheets API via `revolution/laravel-google-sheets`
- **Database:** SQLite (dev), MySQL/PostgreSQL supported
- **Testing:** Pest PHP

## Features

| Feature | Description |
|---------|-------------|
| **Unit Management** | Add/edit apartment units with flat type, floor, and area |
| **Resident Tracking** | Manage occupants with contact info and GPay names |
| **Maintenance Rates** | Configure per-flat-type quarterly charge slabs |
| **Quarterly Billing** | Generate and manage maintenance charges per quarter |
| **Payment Recording** | Track payments from GPay, bank transfer, and cash |
| **Expense Management** | Record building expenses (electricity, water, services) |
| **GPay Screenshot Import** | AI-powered OCR to extract transaction data from screenshots |
| **Bank Statement Import** | Parse HDFC bank statement PDFs (supports password-protected files) |
| **Auto-Reconciliation** | Match imported transactions to payments/expenses via fingerprinting |
| **Review Queue** | Manually verify and assign unmatched transactions |
| **Google Sheets Sync** | Event-driven sync of billing data to Google Sheets |
| **Dashboard** | Quarterly collections, pending dues, unit balances, reconciliation status |
| **Server-Side Pagination** | All list pages paginated at 15 rows with Inertia navigation |

## Module Architecture

The app uses [nwidart/laravel-modules](https://github.com/nWidart/laravel-modules) with four modules:

```
Modules/
  Apartment/   # Unit, Resident, MaintenanceSlab
  Billing/     # Charge, Payment, Expense, MaintenanceChargeGenerator
  Import/      # Upload, ParsedTransaction, GpayScreenshotParser, HdfcStatementParser, TransactionMatcher
  Sheet/       # SheetSyncService, SyncToGoogleSheet job, model observers
```

## Setup

### Quick Start

```bash
git clone https://github.com/kkz6/apartment-management.git
cd apartment-management
composer run setup
```

This installs dependencies, copies `.env`, generates the app key, runs migrations, and builds frontend assets.

### Manual Setup

```bash
composer install
cp .env.example .env
php artisan key:generate
touch database/database.sqlite
php artisan migrate
npm install
npm run build
```

### Seed Sample Data

```bash
php artisan db:seed --class=SampleDataSeeder
```

Creates 10 units, 10 residents, maintenance slabs (1BHK: Rs.1500, 2BHK: Rs.2500, 3BHK: Rs.3500), sample charges for Q4 2025 and Q1 2026, payments, and expenses.

### Run Development Server

```bash
composer run dev
```

Starts Laravel server, queue worker, log tail, and Vite HMR concurrently.

## Environment Variables

### Required

```env
APP_KEY=              # Generated by setup
DB_CONNECTION=sqlite  # Or mysql, pgsql
```

### AI/OCR (for Import module)

```env
ANTHROPIC_API_KEY=    # Claude API key for GPay OCR and PDF parsing
```

### Google Sheets (for Sheet module)

```env
GOOGLE_SERVICE_ENABLED=true
GOOGLE_SERVICE_ACCOUNT_JSON_LOCATION=/path/to/service-account.json
GOOGLE_SHEET_ID=your-spreadsheet-id
```

The Sheet module is optional. If `GOOGLE_SHEET_ID` is not set, observers skip syncing.

### Password-Protected PDFs

Bank statement uploads support password-protected PDFs. Requires `qpdf` on the server:

```bash
# macOS
brew install qpdf

# Ubuntu/Debian
apt install qpdf
```

## Testing

```bash
composer run test
# or
php artisan test
```

81 tests covering all modules: unit models, billing logic, charge generation, transaction matching, reconciliation, and Google Sheets sync.

## Project Structure

```
app/
  Http/Controllers/DashboardController.php
Modules/
  Apartment/
    app/Models/            Unit, Resident, MaintenanceSlab
    app/Http/Controllers/  UnitsController, ResidentsController, MaintenanceSlabsController
    routes/web.php
    tests/
  Billing/
    app/Models/            Charge, Payment, Expense
    app/Http/Controllers/  ChargesController, PaymentsController, ExpensesController
    app/Services/          MaintenanceChargeGenerator
    app/Support/           BillingQuarter
    routes/web.php
    tests/
  Import/
    app/Models/            Upload, ParsedTransaction
    app/Http/Controllers/  UploadsController, ReviewQueueController
    app/Services/          GpayScreenshotParser, HdfcStatementParser, TransactionMatcher
    app/Jobs/              ProcessGpayScreenshot, ProcessBankStatement
    app/Ai/                TransactionExtractorAgent
    routes/web.php
    tests/
  Sheet/
    app/Services/          SheetSyncService
    app/Jobs/              SyncToGoogleSheet
    app/Observers/         PaymentObserver, ChargeObserver, ExpenseObserver
    routes/web.php
    tests/
resources/js/
  Pages/                   Vue 3 pages organized by module
  Components/ui/           shadcn/ui components (data-table, button, card, badge, etc.)
  Layouts/                 AuthenticatedLayout (sidebar + sticky header)
```

## Reconciliation Flow

```
GPay Screenshot / Bank Statement PDF
  -> Upload via /uploads/create
  -> Queued job (ProcessGpayScreenshot / ProcessBankStatement)
  -> AI extracts transactions (Claude API)
  -> ParsedTransaction records created with fingerprints
  -> TransactionMatcher auto-matches:
       Credits -> find resident by GPay name -> create Payment
       Debits  -> create Expense
  -> Bank statement reconciles existing payments (pending_verification -> bank_verified)
  -> Unmatched transactions appear in Review Queue for manual assignment
```

## Google Sheets Sync

Eloquent observers on Payment, Charge, and Expense models dispatch `SyncToGoogleSheet` jobs whenever records change. The service syncs two tab types:

- **Quarterly tab** (e.g. "Q1 2026") -- line-by-line payments and expenses
- **Summary tab** -- per-unit overview with charges due, paid, and balance

Requires a Google Service Account with editor access to the target spreadsheet.

## License

MIT
